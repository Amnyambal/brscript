// ==UserScript==
// @name         Black Log: Property Helper
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Shows property details (houses & apartments) when clicking on IDs in game logs
// @author       You
// @match        https://logs.blackrussia.online/gslogs/*
// @grant        GM_xmlhttpRequest
// @connect      raw.githubusercontent.com
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. Add Styles ---
    const style = document.createElement('style');
    style.textContent = `
        .property-info-btn {
            background: linear-gradient(145deg, #2b8cff, #1f6cd9);
            color: white;
            border: none;
            padding: 3px 8px;
            margin-left: 5px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            vertical-align: middle;
        }
        .property-info-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(43, 140, 255, 0.4);
        }
        .property-highlight {
            background-color: rgba(43, 140, 255, 0.15);
            border-radius: 4px;
            padding: 0 4px;
            font-weight: 500;
        }
        .property-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .property-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .property-modal {
            background: rgba(30, 39, 46, 0.95);
            color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .property-modal-overlay.visible .property-modal {
            transform: scale(1);
        }
        .property-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .property-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2b8cff;
            margin: 0;
        }
        .property-modal-close {
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .property-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .property-modal-content {
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
        }
        .property-detail {
            margin-bottom: 12px;
            display: flex;
        }
        .property-detail-label {
            min-width: 120px;
            font-weight: 500;
            color: #87ceeb;
        }
        .property-detail-value {
            flex: 1;
        }
        .property-type-house {
            color: #ff9e6d;
        }
        .property-type-apartment {
            color: #a076f9;
        }
        .property-price {
            color: #ffd700;
            font-weight: 600;
        }
    `;
    document.head.appendChild(style);

    // --- 2. Data Storage ---
    let houses = [];
    let apartments = [];
    let isDataLoaded = false;
    const processedElements = new WeakSet();

    // --- 3. Fetch Data Functions ---
    function fetchData(url) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                onload: function(response) {
                    try {
                        const data = JSON.parse(response.responseText);
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                },
                onerror: function(error) {
                    reject(error);
                }
            });
        });
    }

    async function loadPropertyData() {
        try {
            console.log('[Property Helper] Loading property data...');
            
            const [housesData, apartmentsData] = await Promise.all([
                fetchData('https://raw.githubusercontent.com/Amnyambal/brscript/refs/heads/main/house.json'),
                fetchData('https://raw.githubusercontent.com/Amnyambal/brscript/refs/heads/main/apartments.json')
            ]);
            
            houses = housesData;
            apartments = apartmentsData;
            isDataLoaded = true;
            
            console.log(`[Property Helper] Loaded: ${houses.length} houses, ${apartments.length} apartments`);
            processPage();
        } catch (error) {
            console.error('[Property Helper] Error loading property data:', error);
            alert('Failed to load property data. Please check your connection and try again.');
        }
    }

    // --- 4. UI Functions ---
    function createModal(property, type) {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'property-modal-overlay';
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'property-modal';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'property-modal-header';
        
        const title = document.createElement('h3');
        title.className = 'property-modal-title';
        title.textContent = type === 'house' ? `üè† –î–æ–º #${property.id}` : `üè¢ –ö–≤–∞—Ä—Ç–∏—Ä–∞ #${property.id}`;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'property-modal-close';
        closeBtn.innerHTML = '&times;';
        closeBtn.setAttribute('aria-label', 'Close modal');
        
        // Create content
        const content = document.createElement('div');
        content.className = 'property-modal-content';
        
        // Add property details
        const details = [
            { label: '–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏', value: type === 'house' ? '–ß–∞—Å—Ç–Ω—ã–π –¥–æ–º' : '–ö–≤–∞—Ä—Ç–∏—Ä–∞', class: 'property-type-house' },
            { label: '–õ–æ–∫–∞—Ü–∏—è', value: property.location || '–ù–µ —É–∫–∞–∑–∞–Ω–∞' },
            { label: '–ö–ª–∞—Å—Å', value: property.type || property.class || '–ù–µ —É–∫–∞–∑–∞–Ω' },
            { label: '–¶–µ–Ω–∞', value: `<span class="property-price">${property.price || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>` },
        ];
        
        if (type === 'house') {
            details.push(
                { label: '–ì–∞—Ä–∞–∂', value: property.garage ? `–ï—Å—Ç—å (ID: ${property.garage})` : '–ù–µ—Ç' }
            );
        } else {
            details.push(
                { label: '–í—Ö–æ–¥', value: property.entrance || '–ù–µ —É–∫–∞–∑–∞–Ω' }
            );
        }
        
        details.forEach(detail => {
            const detailEl = document.createElement('div');
            detailEl.className = 'property-detail';
            
            const labelEl = document.createElement('div');
            labelEl.className = 'property-detail-label';
            labelEl.textContent = detail.label + ':';
            
            const valueEl = document.createElement('div');
            valueEl.className = 'property-detail-value';
            if (typeof detail.value === 'string' && detail.value.includes('<')) {
                valueEl.innerHTML = detail.value;
            } else {
                valueEl.textContent = detail.value;
            }
            
            if (detail.class) {
                valueEl.className = detail.class;
            }
            
            detailEl.appendChild(labelEl);
            detailEl.appendChild(valueEl);
            content.appendChild(detailEl);
        });
        
        // Assemble modal
        header.appendChild(title);
        header.appendChild(closeBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Show modal with animation
        requestAnimationFrame(() => {
            overlay.classList.add('visible');
        });
        
        // Close modal function
        function closeModal() {
            overlay.classList.remove('visible');
            overlay.addEventListener('transitionend', () => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, { once: true });
        }
        
        // Close on button click or overlay click
        closeBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeModal();
        });
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        }, { once: true });
    }

    // --- 5. Main Processing Logic ---
    function processPage() {
        if (!isDataLoaded) return;
        
        // Regular expression to match property IDs in logs
        const propertyRegex = /(–¥–æ–º|–∫–≤–∞—Ä—Ç–∏—Ä–∞)\s*\(sql:\s*(\d+)\)/gi;
        
        // Process all table cells that might contain property IDs
        document.querySelectorAll('#log-table tbody tr.second-row td.td-transaction-desc').forEach(cell => {
            if (processedElements.has(cell)) return;
            
            let content = cell.innerHTML;
            let match;
            const matches = [];
            
            // Find all property mentions in the cell
            while ((match = propertyRegex.exec(content)) !== null) {
                const fullMatch = match[0];
                const type = match[1].trim() === '–¥–æ–º' ? 'house' : 'apartment';
                const sqlId = parseInt(match[2], 10);
                
                if (!isNaN(sqlId)) {
                    matches.push({ fullMatch, type, sqlId });
                }
            }
            
            // Replace matches with highlighted content and buttons
            if (matches.length > 0) {
                let newContent = content;
                const usedIds = new Set();
                
                matches.forEach(({ fullMatch, type, sqlId }) => {
                    if (usedIds.has(sqlId)) return;
                    usedIds.add(sqlId);
                    
                    // Skip if button already exists
                    if (cell.querySelector(`.property-info-btn[data-id="${sqlId}"]`)) return;
                    
                    // Create highlight wrapper
                    const highlightWrapper = `<span class="property-highlight">${fullMatch}</span>`;
                    
                    // Replace only the first occurrence
                    newContent = newContent.replace(fullMatch, highlightWrapper);
                });
                
                cell.innerHTML = newContent;
                
                // Add buttons for each unique property
                usedIds.forEach(sqlId => {
                    const match = matches.find(m => m.sqlId === sqlId);
                    if (!match) return;
                    
                    const { type } = match;
                    const propertyArray = type === 'house' ? houses : apartments;
                    const property = propertyArray.find(p => p.id === sqlId);
                    
                    if (property) {
                        const btn = document.createElement('button');
                        btn.className = 'property-info-btn';
                        btn.dataset.id = sqlId;
                        btn.dataset.type = type;
                        btn.innerHTML = type === 'house' ? 'üè† Info' : 'üè¢ Info';
                        
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            createModal(property, type);
                        });
                        
                        cell.appendChild(btn);
                    }
                });
                
                processedElements.add(cell);
            }
        });
    }

    // --- 6. Initialize ---
    console.log('[Property Helper] Script loaded. Loading property data...');
    loadPropertyData();
    
    // Set up observer for dynamic content
    const observer = new MutationObserver(() => {
        processPage();
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    // Initial processing
    setTimeout(processPage, 1000);
})();
