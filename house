// ==UserScript==
// @name         Black Log: Property Helper
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–º–∞—Ö –∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞—Ö –ø–æ –∏—Ö ID –≤ –ª–æ–≥–∞—Ö
// @author       You
// @match        https://logs.blackrussia.online/gslogs/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ ---
    const style = document.createElement('style');
    style.textContent = `
        .property-info-btn {
            background: linear-gradient(145deg, #2b8cff, #1f6cd9);
            color: white;
            border: none;
            padding: 3px 8px;
            margin-left: 5px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            vertical-align: middle;
        }
        .property-info-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(43, 140, 255, 0.4);
        }
        .property-highlight {
            background-color: rgba(43, 140, 255, 0.15);
            border-radius: 4px;
            padding: 0 4px;
            font-weight: 500;
        }
        .property-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .property-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .property-modal {
            background: rgba(30, 39, 46, 0.95);
            color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .property-modal-overlay.visible .property-modal {
            transform: scale(1);
        }
        .property-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .property-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2b8cff;
            margin: 0;
        }
        .property-modal-close {
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .property-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .property-modal-content {
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
        }
        .property-detail {
            margin-bottom: 12px;
            display: flex;
        }
        .property-detail-label {
            min-width: 120px;
            font-weight: 500;
            color: #87ceeb;
        }
        .property-detail-value {
            flex: 1;
        }
        .property-type-house {
            color: #ff9e6d;
        }
        .property-type-apartment {
            color: #a076f9;
        }
        .property-price {
            color: #ffd700;
            font-weight: 600;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #2b8cff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-message {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
    `;
    document.head.appendChild(style);

    // --- 2. –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö ---
    let houses = [];
    let apartments = [];
    let isDataLoaded = false;
    let isLoading = false;
    const processedElements = new WeakSet();
    const CACHE_KEY = 'property_data_cache';
    const CACHE_EXPIRY = 1 * 60 * 60 * 1000; // 1 —á–∞—Å

    // --- 3. –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ---
    function formatPrice(price) {
        if (!price) return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    function getFromCache() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp > CACHE_EXPIRY) {
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
            return data;
        } catch (error) {
            console.error('[Property Helper] Error reading cache:', error);
            return null;
        }
    }

    function saveToCache(data) {
        try {
            const cacheData = {
                data,
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
        } catch (error) {
            console.error('[Property Helper] Error saving cache:', error);
        }
    }

    async function fetchData(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
        
        try {
            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    async function loadPropertyData() {
        if (isLoading) return;
        isLoading = true;
        
        try {
            console.log('[Property Helper] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–Ω–∞—á–∞–ª–∞
            const cachedData = getFromCache();
            if (cachedData) {
                houses = cachedData.houses;
                apartments = cachedData.apartments;
                isDataLoaded = true;
                console.log('[Property Helper] –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
                processPage();
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å GitHub
            const [housesData, apartmentsData] = await Promise.all([
                fetchData('https://raw.githubusercontent.com/Amnyambal/brscript/refs/heads/main/house.json'),
                fetchData('https://raw.githubusercontent.com/Amnyambal/brscript/refs/heads/main/apartments.json')
            ]);
            
            houses = housesData;
            apartments = apartmentsData;
            isDataLoaded = true;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            saveToCache({ houses, apartments });
            
            console.log(`[Property Helper] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${houses.length} –¥–æ–º–æ–≤, ${apartments.length} –∫–≤–∞—Ä—Ç–∏—Ä`);
            processPage();
        } catch (error) {
            console.error('[Property Helper] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            const cachedData = getFromCache();
            if (!cachedData) {
                alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ fallback
                houses = cachedData.houses;
                apartments = cachedData.apartments;
                isDataLoaded = true;
                console.log('[Property Helper] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ fallback');
                processPage();
            }
        } finally {
            isLoading = false;
        }
    }

    // --- 4. –§—É–Ω–∫—Ü–∏–∏ UI ---
    function createModal(property, type) {
        // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
        const overlay = document.createElement('div');
        overlay.className = 'property-modal-overlay';
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.className = 'property-modal';
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('div');
        header.className = 'property-modal-header';
        
        const title = document.createElement('h3');
        title.className = 'property-modal-title';
        title.textContent = type === 'house' ? `üè† –î–æ–º #${property.id}` : `üè¢ –ö–≤–∞—Ä—Ç–∏—Ä–∞ #${property.id}`;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'property-modal-close';
        closeBtn.innerHTML = '&times;';
        closeBtn.setAttribute('aria-label', '–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ');
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        const content = document.createElement('div');
        content.className = 'property-modal-content';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        const details = [
            { label: '–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏', value: type === 'house' ? '–ß–∞—Å—Ç–Ω—ã–π –¥–æ–º' : '–ö–≤–∞—Ä—Ç–∏—Ä–∞', class: type === 'house' ? 'property-type-house' : 'property-type-apartment' },
            { label: '–õ–æ–∫–∞—Ü–∏—è', value: property.location || '–ù–µ —É–∫–∞–∑–∞–Ω–∞' },
            { label: '–ö–ª–∞—Å—Å', value: property.type || property.class || '–ù–µ —É–∫–∞–∑–∞–Ω' },
            { label: '–¶–µ–Ω–∞', value: `<span class="property-price">${formatPrice(property.price)} ‚ÇΩ</span>` },
        ];
        
        if (type === 'house') {
            details.push(
                { label: '–ì–∞—Ä–∞–∂', value: property.garage ? `–ï—Å—Ç—å (ID: ${property.garage})` : '–ù–µ—Ç' }
            );
        } else {
            details.push(
                { label: '–í—Ö–æ–¥', value: property.entrance || '–ù–µ —É–∫–∞–∑–∞–Ω' },
                { label: '–≠—Ç–∞–∂', value: property.floor || '–ù–µ —É–∫–∞–∑–∞–Ω' }
            );
        }
        
        details.forEach(detail => {
            const detailEl = document.createElement('div');
            detailEl.className = 'property-detail';
            
            const labelEl = document.createElement('div');
            labelEl.className = 'property-detail-label';
            labelEl.textContent = detail.label + ':';
            
            const valueEl = document.createElement('div');
            valueEl.className = 'property-detail-value';
            if (typeof detail.value === 'string' && detail.value.includes('<')) {
                valueEl.innerHTML = detail.value;
            } else {
                valueEl.textContent = detail.value;
            }
            
            if (detail.class) {
                valueEl.className = detail.class;
            }
            
            detailEl.appendChild(labelEl);
            detailEl.appendChild(valueEl);
            content.appendChild(detailEl);
        });
        
        // –°–æ–±–∏—Ä–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        header.appendChild(title);
        header.appendChild(closeBtn);
        modal.appendChild(header);
        modal.appendChild(content);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        requestAnimationFrame(() => {
            overlay.classList.add('visible');
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            overlay.classList.remove('visible');
            overlay.addEventListener('transitionend', () => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, { once: true });
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –∏–ª–∏ –æ–≤–µ—Ä–ª–µ–π
        closeBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeModal();
        });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        }, { once: true });
    }

    // --- 5. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    function processPage() {
        if (!isDataLoaded) return;
        
        // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–æ–º–æ–≤ –∏ –∫–≤–∞—Ä—Ç–∏—Ä
        const propertyRegex = /(–¥–æ–º|–∫–≤–∞—Ä—Ç–∏—Ä–∞)\s*\(sql:\s*(\d+)\)/gi;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        document.querySelectorAll('#log-table tbody tr.second-row td.td-transaction-desc').forEach(cell => {
            if (processedElements.has(cell)) return;
            
            let content = cell.innerHTML;
            let match;
            const matches = [];
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ —è—á–µ–π–∫–µ
            while ((match = propertyRegex.exec(content)) !== null) {
                const fullMatch = match[0];
                const type = match[1].trim() === '–¥–æ–º' ? 'house' : 'apartment';
                const sqlId = parseInt(match[2], 10);
                
                if (!isNaN(sqlId)) {
                    matches.push({ fullMatch, type, sqlId });
                }
            }
            
            // –ó–∞–º–µ–Ω—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            if (matches.length > 0) {
                let newContent = content;
                const usedIds = new Set();
                
                matches.forEach(({ fullMatch, type, sqlId }) => {
                    if (usedIds.has(sqlId)) return;
                    usedIds.add(sqlId);
                    
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if (cell.querySelector(`.property-info-btn[data-id="${sqlId}"]`)) return;
                    
                    // –°–æ–∑–¥–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
                    const highlightWrapper = `<span class="property-highlight">${fullMatch}</span>`;
                    
                    // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
                    newContent = newContent.replace(fullMatch, highlightWrapper);
                });
                
                cell.innerHTML = newContent;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
                usedIds.forEach(sqlId => {
                    const match = matches.find(m => m.sqlId === sqlId);
                    if (!match) return;
                    
                    const { type } = match;
                    const propertyArray = type === 'house' ? houses : apartments;
                    const property = propertyArray.find(p => p.id === sqlId);
                    
                    if (property) {
                        const btn = document.createElement('button');
                        btn.className = 'property-info-btn';
                        btn.dataset.id = sqlId;
                        btn.dataset.type = type;
                        btn.innerHTML = type === 'house' ? 'üè† Info' : 'üè¢ Info';
                        
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            createModal(property, type);
                        });
                        
                        cell.appendChild(btn);
                    }
                });
                
                processedElements.add(cell);
            }
        });
    }

    // --- 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    console.log('[Property Helper] –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏...');
    loadPropertyData();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ DOM –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const observer = new MutationObserver((mutations) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ª–æ–≥–∏
        let needsProcessing = false;
        mutations.forEach(mutation => {
            if (mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && 
                        (node.matches('#log-table tbody tr') || 
                         node.querySelector('#log-table tbody tr'))) {
                        needsProcessing = true;
                    }
                });
            }
        });
        
        if (needsProcessing) {
            setTimeout(processPage, 100);
        }
    });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
    const targetNode = document.querySelector('.main-content') || document.body;
    observer.observe(targetNode, {
        childList: true,
        subtree: true
    });
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(processPage, 500);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    document.addEventListener('click', (e) => {
        if (e.target.closest('#next-page-btn, #prev-page-btn')) {
            setTimeout(processPage, 300);
        }
    });
})();
